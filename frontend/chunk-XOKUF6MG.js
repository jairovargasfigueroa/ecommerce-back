import{a as X}from"./chunk-QSMC3UDR.js";import{b as B,d as F}from"./chunk-XRFPBX2B.js";import{a as Q}from"./chunk-H75MTFYF.js";import{K as N,R as U,d as J}from"./chunk-PQ7QENVN.js";import{Wa as W,_a as z,ab as G,ha as q}from"./chunk-CC66Z2HJ.js";import{Fb as g,Pb as d,Qb as a,Vb as T,Yb as x,Zc as L,_b as m,_c as R,bd as V,dd as A,fb as s,gb as p,kc as c,mc as _,oa as u,oc as O,pa as f,pc as E,qc as w,rc as y,sb as M,xc as D,yb as C,yc as k}from"./chunk-ZV4WQW5U.js";import{g as j}from"./chunk-GAL4ENT6.js";var $="basil",ie=function(i){return i===3?"v3":i},H="https://js.stripe.com",re="".concat(H,"/").concat($,"/stripe.js"),oe=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,ne=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,Z="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",ae=function(i){return oe.test(i)||ne.test(i)},de=function(){for(var i=document.querySelectorAll('script[src^="'.concat(H,'"]')),e=0;e<i.length;e++){var r=i[e];if(ae(r.src))return r}return null},K=function(i){var e=i&&!i.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(re).concat(e);var t=document.head||document.body;if(!t)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return t.appendChild(r),r},ce=function(i,e){!i||!i._registerWrapper||i._registerWrapper({name:"stripe-js",version:"7.2.0",startTime:e})},v=null,P=null,S=null,se=function(i){return function(e){i(new Error("Failed to load Stripe.js",{cause:e}))}},le=function(i,e){return function(){window.Stripe?i(window.Stripe):e(new Error("Stripe.js not available"))}},pe=function(i){return v!==null?v:(v=new Promise(function(e,r){if(typeof window>"u"||typeof document>"u"){e(null);return}if(window.Stripe&&i&&console.warn(Z),window.Stripe){e(window.Stripe);return}try{var t=de();if(t&&i)console.warn(Z);else if(!t)t=K(i);else if(t&&S!==null&&P!==null){var n;t.removeEventListener("load",S),t.removeEventListener("error",P),(n=t.parentNode)===null||n===void 0||n.removeChild(t),t=K(i)}S=le(e,r),P=se(r),t.addEventListener("load",S),t.addEventListener("error",P)}catch(l){r(l);return}}),v.catch(function(e){return v=null,Promise.reject(e)}))},me=function(i,e,r){if(i===null)return null;var t=e[0],n=t.match(/^pk_test/),l=ie(i.version),b=$;n&&l!==b&&console.warn("Stripe.js@".concat(l," was loaded on the page, but @stripe/stripe-js@").concat("7.2.0"," expected Stripe.js@").concat(b,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var I=i.apply(void 0,e);return ce(I,r),I},h,Y=!1,ee=function(){return h||(h=pe(null).catch(function(i){return h=null,Promise.reject(i)}),h)};Promise.resolve().then(function(){return ee()}).catch(function(o){Y||console.warn(o)});var te=function(){for(var i=arguments.length,e=new Array(i),r=0;r<i;r++)e[r]=arguments[r];Y=!0;var t=Date.now();return ee().then(function(n){return me(n,e,t)})};function ue(o,i){o&1&&(d(0,"div"),c(1,"Cargando pedido..."),a())}function fe(o,i){if(o&1&&(d(0,"li"),c(1),a()),o&2){let e=i.$implicit;s(),O(" ",e.producto.nombre," - ",e.cantidad," x $",e.precio_unitario," ")}}function ge(o,i){if(o&1){let e=T();d(0,"div",2)(1,"h2"),c(2,"\u{1F4DD} Confirmar Pedido"),a(),d(3,"p")(4,"strong"),c(5,"Estado:"),a(),c(6),a(),d(7,"p")(8,"strong"),c(9,"Fecha:"),a(),c(10),D(11,"date"),a(),d(12,"p")(13,"strong"),c(14,"Monto total:"),a(),c(15),a(),d(16,"h3"),c(17,"\u{1F6D2} Productos:"),a(),d(18,"ul"),C(19,fe,2,3,"li",3),a(),d(20,"mat-form-field",4)(21,"mat-label"),c(22,"Tipo de Entrega"),a(),d(23,"mat-select",5),y("valueChange",function(t){u(e);let n=m();return w(n.tipoEntrega,t)||(n.tipoEntrega=t),f(t)}),d(24,"mat-option",6),c(25,"Recoger en Tienda"),a(),d(26,"mat-option",7),c(27,"Delivery"),a()()(),d(28,"mat-form-field",4)(29,"mat-label"),c(30,"M\xE9todo de Pago"),a(),d(31,"mat-select",5),y("valueChange",function(t){u(e);let n=m();return w(n.metodoPago,t)||(n.metodoPago=t),f(t)}),d(32,"mat-option",8),c(33,"QR"),a(),d(34,"mat-option",9),c(35,"Efectivo"),a()()(),d(36,"div",10)(37,"button",11),x("click",function(){u(e);let t=m();return f(t.pagarConTarjeta())}),c(38," \u{1F4B3} Pagar con Tarjeta "),a(),d(39,"button",12),x("click",function(){u(e);let t=m();return f(t.finalizarPedido())}),c(40," \u2705 Confirmar Pedido "),a()()()}if(o&2){let e=m();s(6),_(" ",e.pedido.estado,""),s(4),_(" ",k(11,6,e.pedido.fecha_pedido),""),s(5),_(" $",e.pedido.monto_total,""),s(4),g("ngForOf",e.pedido.items),s(4),E("value",e.tipoEntrega),s(8),E("value",e.metodoPago)}}function ve(o,i){o&1&&(d(0,"div")(1,"p"),c(2,"No hay pedido pendiente para confirmar."),a()())}var ke=(()=>{class o{ngOnInit(){this.route.queryParams.subscribe(e=>{e.pago==="exitoso"?this.snackBar.open("\u2705 Pago realizado con \xE9xito","Cerrar",{duration:5e3,panelClass:["snackbar-success"]}):e.pago==="fallido"&&this.snackBar.open("\u26A0\uFE0F El pago fue cancelado o fallido","Cerrar",{duration:5e3,panelClass:["snackbar-error"]}),e.pago&&this.router.navigate([],{queryParams:{}}),localStorage.getItem("redireccionPendiente")==="/confirmar-pedido"?(this.crearPedidoDesdeCarrito(),localStorage.removeItem("redireccionPendiente")):this.obtenerPedidoPendienteActual()})}constructor(e,r,t,n,l){this.api=e,this.carritoService=r,this.router=t,this.route=n,this.snackBar=l,this.stripePromise=te("pk_test_51RGa3uR60AvZBvnPKgJB1xPYOmSy4Ak06GkLjl7aE2o09qjZQxudy1im32X1hyfIQLRyVZ7qd5AJIOE0SuNy6Q9J00dGAHACgC"),this.pedido=null,this.cargando=!0,this.tipoEntrega="tienda",this.metodoPago="efectivo"}pagarConTarjeta(){this.pedido&&(console.log("Entro a pago con tarejta"),this.api.post("pagos/crear-sesion-pago/",{pedido_id:this.pedido.id}).subscribe({next:e=>j(this,null,function*(){let r=yield this.stripePromise;if(console.log("Sessionid de strype",e),r){let t=yield r.redirectToCheckout({sessionId:e.sessionId});t.error&&console.error("Error al redirigir a Stripe:",t.error.message)}}),error:e=>console.error("Error al crear sesi\xF3n de pago:",e)}))}crearPedidoDesdeCarrito(){let e=this.carritoService.obtenerCarrito(),t={items:e.map(n=>({producto:n.id,cantidad:n.cantidad,precio_unitario:n.precio})),estado:"pendiente",tipo_pago:this.metodoPago,tipo_entrega:this.tipoEntrega};console.log("Carritodelpedido",e),console.log("DatosDelPedido",t),this.carritoService.vaciarCarrito(),this.api.post("pedidos/",t).subscribe({next:n=>{console.log("Pedido creado desde carrito:",n),this.obtenerPedidoPendienteActual()},error:n=>{console.error("Error al crear pedido desde carrito:",n)}})}obtenerPedidoPendienteActual(){this.api.get("pedidos/pendiente-actual/").subscribe({next:e=>{this.pedido=e,this.cargando=!1,console.log("Pedido pendiente:",e)},error:e=>{this.cargando=!1,console.error("No hay pedido pendiente o ocurri\xF3 un error:",e)}})}finalizarPedido(){!this.pedido||!this.pedido.id||(console.log("Finalizo pedido"),console.log(`Entrega: ${this.tipoEntrega} | Pago: ${this.metodoPago}`),this.api.patch("pedidos",this.pedido.id,{tipo_entrega:this.tipoEntrega,tipo_pago:this.metodoPago,estado:"completado"}).subscribe({next:e=>{console.log("Pedido finalizado:",e),console.log("Pedido actualizado:",e),this.snackBar.open("Pedido confirmado con \xE9xito","Cerrar",{duration:3e3}),this.carritoService.vaciarCarrito(),this.router.navigate(["/dashboard"])},error:e=>{console.error("Error al finalizar el pedido:",e)}}))}static{this.\u0275fac=function(r){return new(r||o)(p(Q),p(X),p(F),p(B),p(N))}}static{this.\u0275cmp=M({type:o,selectors:[["app-confirmar-pedido"]],decls:3,vars:3,consts:[[4,"ngIf"],["class","pedido-container",4,"ngIf"],[1,"pedido-container"],[4,"ngFor","ngForOf"],["appearance","fill",1,"full-width"],[3,"valueChange","value"],["value","tienda"],["value","delivery"],["value","qr"],["value","efectivo"],[1,"acciones"],["mat-raised-button","","color","primary",3,"click"],["mat-raised-button","","color","accent",3,"click"]],template:function(r,t){r&1&&C(0,ue,2,0,"div",0)(1,ge,41,8,"div",1)(2,ve,3,0,"div",0),r&2&&(g("ngIf",t.cargando),s(),g("ngIf",t.pedido),s(),g("ngIf",!t.pedido&&!t.cargando))},dependencies:[A,L,R,V,U,q,z,W,J,G],styles:[".snackbar-success[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff}.snackbar-error[_ngcontent-%COMP%]{background-color:#f44336;color:#fff}.pedido-container[_ngcontent-%COMP%]{max-width:600px;margin:auto}.full-width[_ngcontent-%COMP%]{width:100%;margin-bottom:16px}.acciones[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-top:20px}.qr-section[_ngcontent-%COMP%]{display:flex;justify-content:center;text-align:center}.qr-section[_ngcontent-%COMP%]   mat-card[_ngcontent-%COMP%]{padding:20px;max-width:300px}.mt-2[_ngcontent-%COMP%]{margin-top:.5rem}.mt-4[_ngcontent-%COMP%]{margin-top:1rem}.mt-6[_ngcontent-%COMP%]{margin-top:1.5rem}.flex[_ngcontent-%COMP%]{display:flex}.space-x-4[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]:not(:last-child){margin-right:1rem}"]})}}return o})();export{ke as ConfirmarPedidoComponent};
